---
phase: 10-polish
plan: 01
type: execute
---

<objective>
Add visual QR detection indicators positioned on detected codes, and upgrade the camera-denied screen with browser-specific recovery steps.

Purpose: Users see exactly which QR codes are detected (visual overlay ON the codes), and can recover from accidental camera denial with clear instructions.
Output: Canvas-drawn detection highlights on QR codes, browser-specific permission-denied help screen with reload button.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-polish/10-CONTEXT.md

# Key source files:
@src/App.tsx
@src/components/QrScanner.tsx
@src/hooks/useAudioEngine.ts
@src/styles.css

# Auto-selected based on dependency graph:
@.planning/phases/02-qr-scanner/02-01-SUMMARY.md
@.planning/phases/02-qr-scanner/02-02-SUMMARY.md
@.planning/phases/08-git-deploy/08-01-SUMMARY.md

**Tech stack available:** Vite, React 19, TypeScript, @yudiel/react-qr-scanner, Web Audio API, gh-pages
**Established patterns:** Inline styles, ref-based callbacks for QrScanner (memo'd, never re-renders), dvh/dvw viewport units

**Key scanner API discovery:**
- `IDetectedBarcode` has `boundingBox` and `cornerPoints` per detected code
- Scanner `components.tracker` accepts a `TrackFunction: (detectedCodes, ctx: CanvasRenderingContext2D) => void`
- Library exports built-in overlay functions: `outline()`, `boundingBox()`, `centerText()` from `@yudiel/react-qr-scanner`
- The tracker draws on a canvas overlay that's already positioned over the camera feed â€” no manual coordinate mapping needed

**Constraining decisions:**
- Scanner is memo'd with `() => true` â€” props are refs, never re-renders
- Scanner uses `components: { finder: false }` â€” custom red outline instead
- Camera status state machine: loading | active | denied | error
- Existing denied screen (App.tsx lines 300-308): minimal text, no reload button, no browser-specific steps
- Existing error screen (App.tsx lines 310-331): has reload button

**Current UX flow:**
1. App loads â†’ dark screen with "Starting camera..."
2. Camera activates â†’ "Tap anywhere to begin scanning" overlay
3. User taps â†’ overlay goes transparent, sounds enabled
4. QR codes detected â†’ sounds play, "Currently Playing" HUD shows in center, debug log at bottom
5. No visual indicator ON the QR codes themselves â€” user can't tell WHICH codes are being read
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add positioned QR detection highlights via scanner tracker</name>
  <files>src/components/QrScanner.tsx</files>
  <action>
Use the scanner's built-in `components.tracker` prop to draw visual highlights on detected QR codes:

1. Import `outline` from `@yudiel/react-qr-scanner` (or write a custom TrackFunction â€” see below)
2. Add `tracker` to the `components` prop on Scanner: `components={{ finder: false, tracker: customTracker }}`
3. Create a custom tracker function that draws a green rounded-rect highlight around each detected code:
   - For each detected code, use `code.boundingBox` (has x, y, width, height)
   - Draw a semi-transparent green fill (`rgba(0, 255, 100, 0.15)`) and a solid green border (`rgba(0, 255, 100, 0.7)`, 3px)
   - Use `ctx.roundRect()` with 8px radius for rounded corners (or fallback to plain rect for older browsers)
   - Optionally draw the rawValue text centered below the box in small white text
4. The tracker function runs every scan cycle (500ms) and the canvas auto-clears between frames â€” no manual cleanup needed

**What to avoid:**
- Do NOT try to position HTML elements over the camera using boundingBox coordinates â€” the canvas tracker handles coordinate mapping automatically
- Do NOT import `outline` and use it as-is if it looks too subtle â€” write a custom function for a clear green highlight
- Do NOT change the Scanner memo strategy â€” tracker is a stable ref, same as onScan/onError

**If `components.tracker` doesn't work or the canvas overlay isn't visible:**
Fallback: Pass `tracker` as a function that uses the built-in `outline` export, confirm it renders, then customize.
  </action>
  <verify>Point phone at QR code â€” see a green highlight box drawn directly on/around the detected QR code. Box appears while code is in frame, disappears when removed.</verify>
  <done>Green highlight boxes render on detected QR codes via canvas tracker. Highlights are clearly visible on camera feed without obstructing it.</done>
</task>

<task type="auto">
  <name>Task 2: Upgrade camera permission denied screen with browser-specific steps</name>
  <files>src/App.tsx</files>
  <action>
Replace the existing minimal denied screen (lines 300-308) with a comprehensive help screen:

1. Detect browser from User-Agent (simple string checks, no library):
   - `navigator.userAgent` contains "Safari" but NOT "Chrome" â†’ Safari/iOS
   - Contains "Chrome" â†’ Chrome (Android or desktop)
   - Otherwise â†’ generic fallback

2. Replace the existing `cameraStatus === 'denied'` block with:
   - Heading: "Camera Access Blocked"
   - Subheading: "Wind Chime needs your camera to scan QR codes. Here's how to fix it:"
   - Browser-specific numbered steps:
     **Chrome (Android):**
     1. Tap the lock icon ðŸ”’ next to the address bar
     2. Tap "Site settings"
     3. Find "Camera" and change to "Allow"
     4. Come back and tap Reload below

     **Safari (iOS):**
     1. Open Settings app on your phone
     2. Scroll down and tap "Safari"
     3. Tap "Camera" under "Settings for Websites"
     4. Change to "Allow"
     5. Come back and tap Reload below

     **Generic:**
     1. Open your browser's settings
     2. Find site permissions or privacy settings
     3. Allow camera access for this site
     4. Come back and tap Reload below

   - A prominent "Reload" button: `onClick={() => window.location.reload()}`
   - Style: centered, max-width 360px, white text on dark background (#111), steps in a numbered list with comfortable spacing

3. Also add a "Reload" button to the existing error screen if it doesn't have one (it does â€” verify)

**What to avoid:**
- Do NOT use a full UA parsing library â€” simple string includes is fine for 3 cases
- Do NOT change the camera status state machine or error detection logic â€” just improve what's rendered
  </action>
  <verify>
  Test by denying camera permission:
  1. On Chrome: Settings â†’ Site Settings â†’ clear permission for this site â†’ reload â†’ deny â†’ see Chrome-specific steps
  2. Verify "Reload" button calls window.location.reload()
  3. Verify the layout looks clean on a phone-width screen
  </verify>
  <done>Permission denied screen shows browser-detected step-by-step recovery instructions with a Reload button</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Green QR detection highlights (canvas tracker) + browser-specific camera denied help screen</what-built>
  <how-to-verify>
    1. Run: npm run dev (in WindChime directory)
    2. Open on phone via network URL
    3. Tap to enable, point at QR codes
    4. Verify: green highlight boxes appear ON the detected QR codes in the camera view
    5. Verify: highlights disappear when codes leave frame
    6. Verify: highlights don't interfere with camera view or sound playback
    7. To test denied screen: clear site data in browser settings, reload, deny camera when prompted
    8. Verify: helpful screen appears with numbered steps specific to your browser
    9. Verify: Reload button works
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Green detection highlights render on QR codes via canvas tracker
- [ ] Highlights are clearly visible but not obstructive
- [ ] Permission denied screen shows browser-specific steps
- [ ] Reload button works on denied screen
- [ ] `npm run build` succeeds
- [ ] Commit all changes
- [ ] Re-deploy to GitHub Pages (`npm run deploy`)
</verification>

<success_criteria>
- Users see exactly which QR codes are being detected (positioned green highlights)
- Users can recover from camera denial with clear, browser-specific instructions
- No regressions to scanning or audio playback
- Deployed to GitHub Pages
</success_criteria>

<output>
After completion, create `.planning/phases/10-polish/10-01-SUMMARY.md`
</output>
